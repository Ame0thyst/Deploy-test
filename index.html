<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Input Multimedia</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
      }
      .preview {
        margin: 10px 0;
      }
      #photoPreview {
        max-width: 300px;
        max-height: 200px;
      }
      #recordingsList {
        margin-top: 10px;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h2>Form Multimedia</h2>
    <form
      id="myForm"
      action="https://formspree.io/f/mzzdlnjw"
      method="POST"
      enctype="multipart/form-data"
    >
      <!-- Input Teks -->
      <div>
        <label for="textInput">Text Input:</label><br />
        <textarea
          id="textInput"
          name="text"
          rows="4"
          cols="50"
          required
        ></textarea>
      </div>

      <!-- Rekam Suara -->
      <div>
        <label>Rekam Suara:</label><br />
        <button type="button" id="startRecord">Mulai Rekam</button>
        <button type="button" id="stopRecord" disabled>Stop Rekam</button>
        <div id="recordingsList"></div>
      </div>

      <!-- Upload Foto -->
      <div>
        <label for="photoInput">Upload Foto:</label><br />
        <input
          type="file"
          id="photoInput"
          name="upload"
          accept="image/*"
          required
        />
        <div class="preview">
          <img id="photoPreview" src="#" alt="Preview Foto" class="hidden" />
        </div>
      </div>

      <button type="submit">Kirim Data</button>
    </form>

    <script>
      // Preview Foto
      const photoInput = document.getElementById("photoInput");
      const photoPreview = document.getElementById("photoPreview");

      photoInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            photoPreview.src = e.target.result;
            photoPreview.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        }
      });

      // Rekam Suara
      let mediaRecorder;
      let audioChunks = [];

      navigator.mediaDevices
        .getUserMedia({ audio: true })
        .then((stream) => {
          mediaRecorder = new MediaRecorder(stream);

          document
            .getElementById("startRecord")
            .addEventListener("click", () => {
              audioChunks = [];
              mediaRecorder.start();
              document.getElementById("startRecord").disabled = true;
              document.getElementById("stopRecord").disabled = false;
            });

          document
            .getElementById("stopRecord")
            .addEventListener("click", () => {
              mediaRecorder.stop();
              document.getElementById("startRecord").disabled = false;
              document.getElementById("stopRecord").disabled = true;
            });

          mediaRecorder.ondataavailable = function (e) {
            audioChunks.push(e.data);
          };

          mediaRecorder.onstop = function () {
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const audioUrl = URL.createObjectURL(audioBlob);

            // Create audio element for preview
            const audio = document.createElement("audio");
            audio.controls = true;
            audio.src = audioUrl;

            // Create hidden input for form submission
            const audioInput = document.createElement("input");
            audioInput.type = "hidden";
            audioInput.name = "audio";
            audioInput.value = audioUrl;

            const recordingsList = document.getElementById("recordingsList");
            recordingsList.innerHTML = "";
            recordingsList.appendChild(audio);
            recordingsList.appendChild(audioInput);
          };
        })
        .catch((err) => {
          console.error("Error accessing microphone:", err);
        });

      // Form Submission
      document
        .getElementById("myForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Create FormData object
          const formData = new FormData(this);

          // Add audio blob to form data
          const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
          formData.append("audio", audioBlob, "recording.wav");

          // Send form data
          fetch(this.action, {
            method: this.method,
            body: formData,
          })
            .then((response) => {
              if (response.ok) {
                alert("Data berhasil dikirim!");
                this.reset();
                photoPreview.classList.add("hidden");
                recordingsList.innerHTML = "";
              } else {
                alert("Terjadi kesalahan saat mengirim data");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });
    </script>
  </body>
</html>
